const disableAOS = () => {
    const botPattern =
        '(googlebot/|Googlebot-Mobile|Googlebot-Image|Google favicon|Mediapartners-Google|bingbot|slurp|java|wget|curl|Commons-HttpClient|Python-urllib|libwww|httpunit|nutch|phpcrawl|msnbot|jyxobot|FAST-WebCrawler|FAST Enterprise Crawler|biglotron|teoma|convera|seekbot|gigablast|exabot|ngbot|ia_archiver|GingerCrawler|webmon |httrack|webcrawler|grub.org|UsineNouvelleCrawler|antibot|netresearchserver|speedy|fluffy|bibnum.bnf|findlink|msrbot|panscient|yacybot|AISearchBot|IOI|ips-agent|tagoobot|MJ12bot|dotbot|woriobot|yanga|buzzbot|mlbot|yandexbot|purebot|Linguee Bot|Voyager|CyberPatrol|voilabot|baiduspider|citeseerxbot|spbot|twengabot|postrank|turnitinbot|scribdbot|page2rss|sitebot|linkdex|Adidxbot|blekkobot|ezooms|dotbot|Mail.RU_Bot|discobot|heritrix|findthatfile|europarchive.org|NerdByNature.Bot|sistrix crawler|ahrefsbot|Aboundex|domaincrawler|wbsearchbot|summify|ccbot|edisterbot|seznambot|ec2linkfinder|gslfbot|aihitbot|intelium_bot|facebookexternalhit|yeti|RetrevoPageAnalyzer|lb-spider|sogou|lssbot|careerbot|wotbox|wocbot|ichiro|DuckDuckBot|lssrocketcrawler|drupact|webcompanycrawler|acoonbot|openindexspider|gnam gnam spider|web-archive-net.com.bot|backlinkcrawler|coccoc|integromedb|content crawler spider|toplistbot|seokicks-robot|it2media-domain-crawler|ip-web-crawler.com|siteexplorer.info|elisabot|proximic|changedetection|blexbot|arabot|WeSEE:Search|niki-bot|CrystalSemanticsBot|rogerbot|360Spider|psbot|InterfaxScanBot|Lipperhey SEO Service|CC Metadata Scaper|g00g1e.net|GrapeshotCrawler|urlappendbot|brainobot|fr-crawler|binlar|SimpleCrawler|Livelapbot|Twitterbot|cXensebot|smtbot|bnf.fr_bot|A6-Indexer|ADmantX|Facebot|Twitterbot|OrangeBot|memorybot|AdvBot|MegaIndex|SemanticScholarBot|ltx71|nerdybot|xovibot|BUbiNG|Qwantify|archive.org_bot|Applebot|TweetmemeBot|crawler4j|findxbot|SemrushBot|yoozBot|lipperhey|y!j-asr|Domain Re-Animator Bot|AddThis)';
    const re = new RegExp(botPattern, 'i');
    return re.test(navigator.userAgent) || window.outerWidth < 768;
};
window.isMobileDevice = () => window.orientation !== undefined || navigator.userAgent.indexOf('IEMobile') !== -1;

jQuery(document).ready(function($) {

    // ?? AOS INIT + SEO FRIENDLY
    
    setTimeout(() => {
        if (window.AOS !== undefined) {
            window.AOS.init({
                offset: 100,
                duration: 1000,
                startEvent: 'DOMContentLoaded',
                easing: 'ease-out',
                delay: 0, //0
                once: true,
                disable: disableAOS,
            });
        }
        $( window ).resize(window.AOS.refresh());
        document.querySelectorAll('.div-prllx:not(.prllx-processed)').forEach((prllx) => {
          // const modifier = prllx.getAttribute('data-modifier');
          window.basicScroll
            .create({
              elem: prllx,
              from: 'top-bottom',
              to: 'bottom-top',
              direct: true,
              props: {
                '--translateY': {
                  from: '0',
                  to: '20%',
                },
              },
            })
            .start();
          prllx.classList.add('prllx-processed');
      });
    }, 500);

    document.addEventListener('readystatechange', event => {
        if (event.target.readyState === 'complete' || event.target.readyState === 'loaded') {
            window.AOS.refresh();
        }
    });
    if (disableAOS()) {
        document.body.parentNode.classList.add('no-aos');
    } else {
        document.body.parentNode.classList.remove('no-aos');
        setTimeout(() => {
            window.AOS.refresh();
        }, 500);
    }
    /* --- END AOS --- */

    //Smooth scroll
    var smoothScrollSpeed = 750; // Durée de l'animation (en ms)
    $(document).on('click', 'a[href*="#"]', function(e) { // Au clic sur un élément
        console.log(e);
        var href = $(e.currentTarget).attr('href'); // Page cible
        if (href.indexOf('#') > -1) {
            var anchor = href.indexOf('#') === 0 ? href : '#' + href.split('#')[1];
            if ((href.indexOf('#') === 0 || window.location.pathname === href.split('#')[0] || window.location.protocol + '//' + window.location.hostname + window.location.pathname === href.split('#')[0]) && $(anchor).length) {
                e.preventDefault();
                $('html, body').animate({ scrollTop: $(anchor).offset().top - 115 }, smoothScrollSpeed); // Go
                return false;
            }
        }
    });
    if (window.location.hash && window.location.hash !== '#' && $(window.location.hash).length) {
        setTimeout(function() {
            $('html, body').animate({ scrollTop: $(window.location.hash).offset().top - 115 }, smoothScrollSpeed);
        }, 1000);
    }
    // ?? Affichage du menu principal
    $('#menu-menu-principal .menu-item-has-children ul.sub-menu').before('<button class="navbar-toggler" type="button"><i class="far fa-chevron-down"></i></button>');
    $('#menu-menu-principal button.navbar-toggler').click(function() {
        if ($(this).parent().hasClass('active')) {
            $(this).parent().removeClass('active');
            $(this).next('.sub-menu').slideUp();
        } else {
            // ?? Ménage et fermeture des onglets ouverts aux alentours selon hiérarchie
            if ($(this).next('.sub-menu').hasClass('level-2')) {
                $('.sub-menu.level-3').slideUp(); // tous les items intérieurs ne sont pas déployés par défaut (caché)
                $('#menu-menu-principal .menu-item-has-children').removeClass('active');
                $('#menu-menu-principal .sub-menu.level-2').slideUp(); // niveau 2 se rangent (dont l'actuel)
            } else if ($(this).next('.sub-menu').hasClass('level-3')) {
                $('.sub-menu.level-4').slideUp(); // tous les items intérieurs ne sont pas déployés par défaut (caché)
                $('.sub-menu.level-3').slideUp();
                $('.sub-menu.level-3').parent().removeClass('active');
            } else if ($(this).next('.sub-menu').hasClass('level-4')) {
                $('.sub-menu.level-4').slideUp();
                $('.sub-menu.level-4').parent().removeClass('active');
            }
            // ?? On déploie le contenu du sous-menu pour l'item courant
            $(this).parent().addClass('active');
            $(this).next('.sub-menu').slideDown();
        }
    });

    //Menu burger
    let menu = $('#menus-container');
    let menuTopMobile = $('#menus-container-mobile')
    $('#menu-mobile').click(function() {
        $(this).toggleClass('is-active');
        menu.toggleClass('is-active');
        menuTopMobile.toggleClass('menu-open');
    });
    if (menu.hasClass('is-active') && !menu.is(e.target) && menu.has(e.target).length === 0) {
        menu.toggleClass('is-active');
        menuTopMobile.toggleClass('menu-open');
    }
    $('#menus-container a').click(function() {
        if ($(this).attr('href') != undefined && $(this).attr('href') != '#') {
            $('#menu-mobile').toggleClass('is-active');
            menu.toggleClass('is-active');
            menuTopMobile.toggleClass('menu-open');
        }
    });


    //----MODIFICATIONS STRUCTURE MENU PRINCIPAL-----//
    //Entoure le contenu de sub-menu avec une div conteneur
    $('.sub-menu').wrapInner('<div class="conteneur"></div>');

    //Ajoute classes level 2 et 3 et 4
    $('#menus-container .menu-item-has-children > .sub-menu').addClass('level-2');
    $('#menus-container .sub-menu .sub-menu').removeClass('level-2').addClass('level-3');
    $('#menus-container .sub-menu .sub-menu .sub-menu').removeClass('level-3').addClass('level-4');
    // FAQ
    $(".collapseomatic").click(function(e) {
        e.stopImmediatePropagation();
        if (!$(this).hasClass('colomat-visited')) {
            $(this).addClass('colomat-visited');
            $(this).addClass('colomat-close');
        } else {
            $(this).removeClass('colomat-visited');
            $(this).removeClass('colomat-close');
        }
    });


    // ?? -----------GENERAL
    /***** VARIABLES *****/
    const head = document.querySelector("#header");

    // ?? Smooth scroll
    userHasScrolled = false;
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = () => {
        userHasScrolled = true;
        sticky();

    };
    // ?? Sticky menu
    function sticky() {
        var top = window.scrollY;
        if (top > 50) {
            head.classList.add('sticky');
        } else if (top <= 50) {
            head.classList.remove('sticky');
        }
    }
    
    //----FORMULAIRE SELECT-----//
    $(".custom-select").each(function() {
      var classes = $(this).attr("class").replace('form-control', ''),
        id = $(this).attr("id"),
        name = $(this).attr("name");
      var template = '<div class="' + classes + '">';
      template +=
        '<span class="custom-select-trigger form-control">' +
        $(this).attr("placeholder") +
        "</span>";
      template += '<div class="custom-options">';
      $(this)
        .find("option")
        .each(function() {
          template +=
            '<span class="custom-option" data-value="' +
            $(this).attr("value") +
            '">' +
            $(this).html() +
            "</span>";
        });
      template += "</div></div>";
    
      $(this).wrap('<div class="custom-select-wrapper"></div>');
      $(this).hide();
      $(this).after(template);
    });
    $(".custom-select-trigger").on("click", function(event) {
      const classes = $(this).parents(".custom-select").hasClass('opened')
      if ($(this).parents(".simple").length > 0) {
        $(document).one("click", function() {
          $(".custom-select").removeClass("opened");
        });
      } else {
        $(document).on("click", function(e) {
          if (e.target.matches('.custom-option')) {
            return false
          } else {
            $(".custom-select").removeClass("opened");
          }
        });
      }
      $(".custom-select").removeClass("opened");
      if (!classes) {
        $(this)
          .parents(".custom-select")
          .addClass("opened");
      }
      event.stopPropagation();
    });
    $(".custom-option").on("click", function() {
      if ($(this).parents(".multiple").length > 0) {
        let selectVal =  $(this).parents(".custom-select-wrapper").find("select").val() || []
        const val = $(this).data("value")
        const text = $(this).parents(".custom-select-wrapper").find("select").attr("placeholder")
        if($.inArray(val, selectVal) !== -1) {
          selectVal = jQuery.grep(selectVal, function(value) {
            return value != val;
          });
          $(this).removeClass("selection");
        } else {
          selectVal.push(val)
          $(this).addClass("selection");
        }
        $(this)
          .parents(".custom-select")
          .find(".custom-select-trigger")
          .text(() => {
            return selectVal.length > 0 ? selectVal[0] : text
          });
        $(this)
          .parents(".custom-select-wrapper")
          .find("select")
          .val(selectVal)
      } else {
        $(this)
          .parents(".custom-select-wrapper")
          .find("select")
          .val($(this).data("value"));
        $(this)
          .parents(".custom-options")
          .find(".custom-option")
          .removeClass("selection");
        $(this).addClass("selection");
        $(this)
          .parents(".custom-select")
          .removeClass("opened");
        $(this)
          .parents(".custom-select")
          .find(".custom-select-trigger")
          .text($(this).text());
      }
    });
      
});
